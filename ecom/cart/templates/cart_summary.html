{% extends "base.html" %}
{% block content %}
{% load static %}

<div class="container my-4">
    <br>
    <h2>Your Shopping Cart</h2>
    <br><br>

    {% if cart_products %}
    <div class="container">
        {% for item in cart_products %}
            <div class="panel panel-default item item-thumbnail" style="margin-bottom:20px;">
            <div class="row">
                <div class="col-md-4 text-center item-image" style="margin-top:35px;">
                <img src="{{ item.product.image.url }}"
                    class="img-responsive center-block"
                    alt="{{ item.product.name }}">
                    <div class="discount">{{ item.product.discount }}% OFF</div>
                </div>
                <div class="col-md-8">
                <div class="panel-body text-center">
                    <h4>{{ item.product.name }}</h4>
                    <p>{{ item.product.description|truncatechars:120 }}</p>

                    {% if item.product.is_discounted %}
                        <span class="text-warning">Discount</span><br>
                        <del>${{ item.product.price }}</del><br>
                        ${{ item.product.discount_price }}
                    {% else %}
                        <strong>${{ item.product.price }}</strong>
                    {% endif %}
                    <br><br>
                    <div class="row justify-content-center">
                    <div class="col-md-3">Quantity:</div>
                    <div class="col-md-2">
                        <select class="form-control input-sm" id="qty{{ item.product.id }}">
                            {% for i in "12345" %}
                            <option value="{{ forloop.counter }}"
                                {% if forloop.counter == item.qty %}selected{% endif %}>
                                {{ forloop.counter }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    </div>
                    <br>
                    <a href="{% url 'home' %}" class="btn btn-default">Home</a>
                    
                    <button class="btn btn-default update-cart update-item" data-product="{{ item.product.id }}">
                        Update
                    </button>
                    <button class="btn btn-danger delete-product delete-item" data-product="{{ item.product.id }}">
                        Remove
                    </button>
                </div>
                </div>
            </div>
            </div>
            <br>
        {% endfor %}

            <div align="right"><h3>Total : $ {{ totals }}</h3>
            <a href="{% url 'checkout_cart' %}" class="btn btn-success">Checkout</a>
            </div>
    </div>
    {% else %}
        <h3 class="text-center">Your cart is empty.</h3>
        <br>
        <center>
        <a href="{% url 'home' %}" class="btn btn-default">Go to Home</a>
        </center>
    {% endif %}

<br><br><br><br>
</div>

<script>
$(document).on('click', '.update-item', function (e) {
    e.preventDefault();

    let product_id = $(this).data('product');
    let qty = $('#qty' + product_id).val();

    $.ajax({
        type: 'POST',
        url: "{% url 'cart_update' %}",
        data: {
            product_id: product_id,
            product_qty: qty,
            action: 'post',
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function () {
            location.reload();
        }
    });
});


$(document).on('click', '.delete-item', function (e) {
    e.preventDefault();

    let product_id = $(this).data('product');

    $.ajax({
        type: 'POST',
        url: "{% url 'cart_delete' %}",
        data: {
            product_id: product_id,
            action: 'post',
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function () {
            location.reload();
        }
    });
});


</script>

{% endblock content %}